# Setup Scripts

Automation scripts for AWS Bedrock AgentCore deployment with shared resources.

## Quick Start

### One Command Setup + Deploy

```bash
# Setup and deploy everything
./scripts/setup.sh --deploy
```

### Step-by-Step (Recommended)

```bash
# 1. Create shared resources (IAM role, ECR, memory)
./scripts/setup_shared_resources.sh

# 2. Configure all 5 agents
./scripts/configure_agents.sh

# 3. Deploy all agents
./scripts/deploy_all.sh
```

## Scripts Overview

### `setup.sh` - Master Setup Script

Runs everything in sequence.

**Usage:**
```bash
# Setup only (no deployment)
./scripts/setup.sh

# Setup + deploy all agents
./scripts/setup.sh --deploy
```

**What it does:**
1. ✅ Creates shared IAM execution role
2. ✅ Creates shared ECR repository
3. ✅ Creates shared memory (STM_ONLY)
4. ✅ Configures all 5 agents with shared resources
5. ✅ Deploys all agents (if `--deploy` flag used)

**Time:** ~2 min (setup) + ~60-75 min (deployment if enabled)

---

### `setup_shared_resources.sh` - Create AWS Resources

Creates shared resources used by all agents.

**Creates:**
- IAM execution role: `AgentCoreSharedExecutionRole`
- ECR repository: `agentcore-agents`
- Shared memory: `shared-agent-memory`

**Output:** Saves to `.env` and exports variables

**Idempotent:** Safe to re-run (skips existing resources)

---

### `configure_agents.sh` - Configure All Agents

Configures 5 agents with shared resources.

**Agents:**
- `orchestrator` - Main coordinator
- `github` - GitHub integration
- `jira` - JIRA integration
- `planning` - Task planning
- `coding` - Code generation

**Configuration:**
- Shared execution role
- Shared ECR repository (different tags per agent)
- Shared memory
- No OAuth
- No observability (--disable-otel)

**Output:** Updates `.bedrock_agentcore.yaml`

---

### `deploy_all.sh` - Deploy All Agents

Deploys all 5 agents to AWS.

**Time:** ~60-75 minutes (12-15 min per agent)

**What it does:**
- Builds Docker images
- Pushes to shared ECR (tagged per agent)
- Deploys to AgentCore Runtime

---

## Prerequisites

- AWS CLI configured
- Python 3.10+
- `uv` package manager
- `jq` installed

```bash
# Install dependencies
uv sync
```

---

## Shared Resources Architecture

**Why shared resources?**
- ✅ One IAM role for all agents (simpler permissions)
- ✅ One ECR repo (cost-effective, easier management)
- ✅ One memory instance (agents share context)
- ✅ Faster setup and deployment

**What's NOT shared:**
- Agent runtime instances (separate deployments)
- Agent ARNs (unique per agent)
- Container image tags (different per agent)

---

## Manual Setup

Run scripts individually:

```bash
# Step 1: Create resources
./scripts/setup_shared_resources.sh

# Step 2: Configure agents
./scripts/configure_agents.sh

# Step 3: Deploy one agent
uv run agentcore launch --agent orchestrator

# Or deploy all
./scripts/deploy_all.sh
```

## Testing After Deployment

```bash
# Check status
uv run agentcore status --agent orchestrator

# Invoke agents
uv run agentcore invoke '{"prompt": "Hello"}' --agent orchestrator
uv run agentcore invoke '{"prompt": "Plan a task"}' --agent planning
uv run agentcore invoke '{"prompt": "Write code"}' --agent coding
```

---

## Environment Variables

**Required in `.env`:**
```bash
AWS_REGION=ap-southeast-2
```

**Auto-generated by scripts:**
```bash
SHARED_EXECUTION_ROLE_ARN=arn:aws:iam::...
SHARED_ECR_REPOSITORY=agentcore-agents
SHARED_MEMORY_ID=mem-...
```

---

## Troubleshooting

**Resources already exist:**
- Scripts are idempotent, safe to re-run

**Configuration out of sync:**
```bash
./scripts/configure_agents.sh
```

**Redeploy single agent:**
```bash
uv run agentcore launch --agent orchestrator
```

**View logs:**
```bash
uv run agentcore logs --agent orchestrator --follow
```

---

## Testing Agents

There are two ways to test agents:

### 1. Local Testing (No AWS Required)

Test agents locally with mock authentication:

```bash
# Coding Agent (no auth needed)
uv run scripts/test_coding_local.py 'what can you do'
uv run scripts/test_coding_local.py 'create a hello world script'

# GitHub Agent (mock auth - structure testing only)
uv run scripts/test_github_local.py 'what can you do'
uv run scripts/test_github_local.py 'explain your tools'

# JIRA Agent (mock auth - structure testing only)
uv run scripts/test_jira_local.py 'what can you do'
uv run scripts/test_jira_local.py 'list available operations'
```

**Pros:**
- Fast iteration
- No AWS deployment needed
- No OAuth configuration required
- Good for testing agent logic and structure

**Cons:**
- GitHub/JIRA API calls will fail (mock tokens aren't real)
- Can't test real OAuth flows
- Can't test deployed integrations

### 2. AWS Deployment Testing

Test deployed agents in AWS:

```bash
# Must be deployed first
./invoke_coding.sh 'what can you do'
./invoke_github.sh 'list my repositories'  # Requires OAuth
./invoke_jira.sh 'show my projects'  # Requires OAuth
./invoke_orchestrator.sh 'coordinate agents'
./invoke_planning.sh 'plan a task'
```

**Pros:**
- Tests real OAuth flows
- Tests actual API integrations
- End-to-end validation
- Production-like environment

**Cons:**
- Requires AWS deployment
- Requires OAuth configuration
- Slower iteration cycle

### Quick Reference

| Agent | Local Testing | AWS Testing |
|-------|--------------|-------------|
| Coding | `uv run scripts/test_coding_local.py` | `./invoke_coding.sh` |
| GitHub | `uv run scripts/test_github_local.py` | `./invoke_github.sh` |
| JIRA | `uv run scripts/test_jira_local.py` | `./invoke_jira.sh` |
| Orchestrator | N/A | `./invoke_orchestrator.sh` |
| Planning | N/A | `./invoke_planning.sh` |
